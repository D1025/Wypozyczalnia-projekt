services:
  postgres:
    image: ${POSTGRES_IMAGE:-postgres:15}
    container_name: ${POSTGRES_CONTAINER_NAME:-wypozyczalnia-postgres}
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-wypozyczalnia}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - wypozyczalnia-network

  postgres-keycloak:
    image: ${KEYCLOAK_POSTGRES_IMAGE:-postgres:15}
    container_name: ${KEYCLOAK_POSTGRES_CONTAINER_NAME:-keycloak-postgres}
    environment:
      POSTGRES_DB: ${KEYCLOAK_POSTGRES_DB:-keycloak}
      POSTGRES_USER: ${KEYCLOAK_POSTGRES_USER:-keycloak}
      POSTGRES_PASSWORD: ${KEYCLOAK_POSTGRES_PASSWORD:-keycloak}
    ports:
      - "${KEYCLOAK_POSTGRES_PORT:-5433}:5432"
    volumes:
      - keycloak_postgres_data:/var/lib/postgresql/data
    networks:
      - wypozyczalnia-network

  keycloak:
    image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:22.0}
    container_name: ${KEYCLOAK_CONTAINER_NAME:-wypozyczalnia-keycloak}
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: ${KC_DB:-postgres}
      KC_DB_URL: ${KC_DB_URL:-jdbc:postgresql://postgres-keycloak:5432/keycloak}
      KC_DB_USERNAME: ${KC_DB_USERNAME:-keycloak}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD:-keycloak}
    ports:
      - "${KEYCLOAK_PORT:-8086}:8080"
    depends_on:
      - postgres-keycloak
    volumes:
      - ./wypozyczalnia/keycloak-realm:/opt/keycloak/data/import
    command: ${KEYCLOAK_COMMAND:-start-dev --import-realm}
    networks:
      - wypozyczalnia-network

  keycloak-init:
    image: ${KEYCLOAK_IMAGE:-quay.io/keycloak/keycloak:22.0}
    container_name: ${KEYCLOAK_INIT_CONTAINER_NAME:-wypozyczalnia-keycloak-init}
    depends_on:
      - keycloak
    environment:
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://keycloak:8080}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-wypozyczalnia}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KEYCLOAK_APP_CLIENT_ID: ${KEYCLOAK_RESOURCE:-wypozyczalnia-app}
      APP_ADMIN_USERNAME: ${APP_ADMIN_USERNAME:-admin}
      APP_ADMIN_PASSWORD: ${APP_ADMIN_PASSWORD:-admin}
      APP_ADMIN_EMAIL: ${APP_ADMIN_EMAIL:-admin@example.com}
      APP_ADMIN_ROLE: ${APP_ADMIN_ROLE:-LIBRARIAN}
    entrypoint: ["/bin/sh", "-c"]
    command: "/opt/keycloak/init/init-admin.sh"
    volumes:
      - ./wypozyczalnia/keycloak-realm:/opt/keycloak/data/import
      - ./wypozyczalnia/keycloak-realm/init-admin.sh:/opt/keycloak/init/init-admin.sh:ro
    restart: "no"
    networks:
      - wypozyczalnia-network

  backend:
    build: ${BACKEND_BUILD_PATH:-./wypozyczalnia}
    container_name: ${BACKEND_CONTAINER_NAME:-wypozyczalnia-backend}
    ports:
      - "${BACKEND_PORT:-8080}:8080"
    environment:
      DB_HOST: ${DB_HOST:-postgres}
      DB_PORT: ${DB_PORT:-5432}
      DB_NAME: ${DB_NAME:-wypozyczalnia}
      DB_USER: ${DB_USER:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-password}
      SPRING_DATASOURCE_USERNAME: ${DB_USER:-postgres}
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD:-password}
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://keycloak:8080}
      KEYCLOAK_AUTH_SERVER_URL: ${KEYCLOAK_URL:-http://keycloak:8080}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
      KEYCLOAK_ADMIN_USERNAME: ${KEYCLOAK_ADMIN_USERNAME:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
    depends_on:
      - postgres
      - postgres-keycloak
      - keycloak
    networks:
      - wypozyczalnia-network

volumes:
  postgres_data:
  keycloak_postgres_data:

networks:
  wypozyczalnia-network:
    driver: bridge